// Backbone.CollectionBinder v0.1.1
// (c) 2012 Bart Wood
// Distributed Under MIT License

(function(){if(!Backbone){throw"Please include Backbone.js before Backbone.ModelBinder.js"}if(!Backbone.ModelBinder){throw"Please include Backbone.ModelBinder.js before Backbone.CollectionBinder.js"}Backbone.CollectionBinder=function(a){_.bindAll(this);this._elManagerFactory=a;if(!this._elManagerFactory)throw"elManagerFactory must be defined.";this._elManagerFactory.trigger=this.trigger};Backbone.CollectionBinder.VERSION="0.1.1";_.extend(Backbone.CollectionBinder.prototype,Backbone.Events,{bind:function(a,b){this.unbind();if(!a)throw"collection must be defined";if(!b)throw"parentEl must be defined";this._collection=a;this._elManagerFactory.setParentEl(b);this._collection.each(function(a){this._onCollectionAdd(a)},this);this._collection.on("add",this._onCollectionAdd,this);this._collection.on("remove",this._onCollectionRemove,this);this._collection.on("reset",this._onCollectionReset,this)},unbind:function(){if(this._collection!==undefined){this._collection.off("add",this._onCollectionAdd);this._collection.off("remove",this._onCollectionRemove);this._collection.off("reset",this._onCollectionReset)}this._removeAllElManagers()},getManagerForEl:function(a){var b,c,d=_.values(this._elManagers);for(b=0;b<d.length;b++){c=d[b];if(c.isElContained(a)){return c}}return undefined},getManagerForModel:function(a){var b,c,d=_.values(this._elManagers);for(b=0;b<d.length;b++){c=d[b];if(c.getModel()===a){return c}}return undefined},_onCollectionAdd:function(a){this._elManagers[a.cid]=this._elManagerFactory.makeElManager(a);this._elManagers[a.cid].createEl()},_onCollectionRemove:function(a){this._removeElManager(a)},_onCollectionReset:function(){this._removeAllElManagers();this._collection.each(function(a){this._onCollectionAdd(a)},this);this.trigger("elsReset",this._collection)},_removeAllElManagers:function(){_.each(this._elManagers,function(a){a.removeEl();delete this._elManagers[a._model.cid]},this);delete this._elManagers;this._elManagers={}},_removeElManager:function(a){if(this._elManagers[a.cid]!==undefined){this._elManagers[a.cid].removeEl();delete this._elManagers[a.cid]}}});Backbone.CollectionBinder.ElManagerFactory=function(a,b,c){_.bindAll(this);this._elHtml=a;this._bindings=b;this._options=c;if(!_.isString(this._elHtml))throw"elHtml must be a valid html string";if(this._options==undefined)this._options={}};_.extend(Backbone.CollectionBinder.ElManagerFactory.prototype,{setParentEl:function(a){this._parentEl=a},makeElManager:function(a){var b={_model:a,createEl:function(){this._el=$(this._elHtml);if("placement"in this._options&&this._options["placement"]=="before"){$(this._parentEl).prepend(this._el)}else{$(this._parentEl).append(this._el)}if(this._bindings){if(_.isString(this._bindings)){this._modelBinder=new Backbone.ModelBinder;this._modelBinder.bind(this._model,this._el,Backbone.ModelBinder.createDefaultBindings(this._el,this._bindings))}else if(_.isObject(this._bindings)){this._modelBinder=new Backbone.ModelBinder;this._modelBinder.bind(this._model,this._el,this._bindings)}else{throw"Unsupported bindings type, please use a boolean or a bindings hash"}}this.trigger("elCreated",this._model,this._el)},removeEl:function(){if(this._modelBinder!==undefined){this._modelBinder.unbind()}this._el.remove();this.trigger("elRemoved",this._model,this._el)},isElContained:function(a){return this._el===a||$(this._el).has(a).length>0},getModel:function(){return this._model},getEl:function(){return this._el}};_.extend(b,this);return b}});Backbone.CollectionBinder.ViewManagerFactory=function(a,b){_.bindAll(this);this._viewCreator=a;this._options=b;if(!_.isFunction(this._viewCreator))throw"viewCreator must be a valid function that accepts a model and returns a backbone view";if(this._options==undefined)this._options={}};_.extend(Backbone.CollectionBinder.ViewManagerFactory.prototype,{setParentEl:function(a){this._parentEl=a},makeElManager:function(a){var b={_model:a,createEl:function(){this._view=this._viewCreator(a);if("placement"in this._options&&this._options["placement"]=="before"){$(this._parentEl).prepend(this._view.render(this._model).el)}else{$(this._parentEl).append(this._view.render(this._model).el)}this.trigger("elCreated",this._model,this._view)},removeEl:function(){if(this._view.close!==undefined){this._view.close()}else{this._view.$el.remove();console.log("warning, you should implement a close() function for your view, you might end up with zombies")}this.trigger("elRemoved",this._model,this._view)},isElContained:function(a){return this._view.el===a||this._view.$el.has(a).length>0},getModel:function(){return this._model},getEl:function(){return this._view.el}};_.extend(b,this);return b}})}).call(this)