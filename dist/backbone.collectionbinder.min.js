/**
 * Backbone.ModelBinder v0.1.6
 * https://github.com/theironcook/Backbone.ModelBinder
 *
 * Copyright Â© 2012 Bart Wood
 * Released under the MIT license.
 */
(function(){if(!Backbone)throw"Please include Backbone.js before Backbone.ModelBinder.js";if(!Backbone.ModelBinder)throw"Please include Backbone.ModelBinder.js before Backbone.CollectionBinder.js";Backbone.CollectionBinder=function(e,t){_.bindAll(this),this._elManagers={},this._elManagerFactory=e;if(!this._elManagerFactory)throw"elManagerFactory must be defined.";this._elManagerFactory.trigger=this.trigger,this._options=t||{}},Backbone.CollectionBinder.VERSION="0.1.1",_.extend(Backbone.CollectionBinder.prototype,Backbone.Events,{bind:function(e,t){this.unbind();if(!e)throw"collection must be defined";if(!t)throw"parentEl must be defined";this._collection=e,this._elManagerFactory.setParentEl(t),this._onCollectionReset(),this._collection.on("add",this._onCollectionAdd,this),this._collection.on("remove",this._onCollectionRemove,this),this._collection.on("reset",this._onCollectionReset,this)},unbind:function(){this._collection!==undefined&&(this._collection.off("add",this._onCollectionAdd),this._collection.off("remove",this._onCollectionRemove),this._collection.off("reset",this._onCollectionReset)),this._removeAllElManagers()},getManagerForEl:function(e){var t,n,r=_.values(this._elManagers);for(t=0;t<r.length;t++){n=r[t];if(n.isElContained(e))return n}return undefined},getManagerForModel:function(e){var t,n,r=_.values(this._elManagers);for(t=0;t<r.length;t++){n=r[t];if(n.getModel()===e)return n}return undefined},_onCollectionAdd:function(e){this._elManagers[e.cid]=this._elManagerFactory.makeElManager(e),this._elManagers[e.cid].createEl(),this._options.autoSort&&this.sortRootEls()},_onCollectionRemove:function(e){this._removeElManager(e)},_onCollectionReset:function(){this._removeAllElManagers(),this._collection.each(function(e){this._onCollectionAdd(e)},this),this.trigger("elsReset",this._collection)},_removeAllElManagers:function(){_.each(this._elManagers,function(e){e.removeEl(),delete this._elManagers[e._model.cid]},this),delete this._elManagers,this._elManagers={}},_removeElManager:function(e){this._elManagers[e.cid]!==undefined&&(this._elManagers[e.cid].removeEl(),delete this._elManagers[e.cid])},sortRootEls:function(){this._collection.each(function(e,t){var n=this.getManagerForModel(e);if(n){var r=n.getEl(),i=this._elManagerFactory.getParentEl().children();i[t]!==r[0]&&(r.detach(),r.insertBefore(i[t]))}},this)}}),Backbone.CollectionBinder.ElManagerFactory=function(e,t){_.bindAll(this),this._elHtml=e,this._bindings=t;if(!_.isString(this._elHtml))throw"elHtml must be a valid html string"},_.extend(Backbone.CollectionBinder.ElManagerFactory.prototype,{setParentEl:function(e){this._parentEl=e},getParentEl:function(){return this._parentEl},makeElManager:function(e){var t={_model:e,createEl:function(){this._el=$(this._elHtml),$(this._parentEl).append(this._el);if(this._bindings)if(_.isString(this._bindings))this._modelBinder=new Backbone.ModelBinder,this._modelBinder.bind(this._model,this._el,Backbone.ModelBinder.createDefaultBindings(this._el,this._bindings));else{if(!_.isObject(this._bindings))throw"Unsupported bindings type, please use a boolean or a bindings hash";this._modelBinder=new Backbone.ModelBinder,this._modelBinder.bind(this._model,this._el,this._bindings)}this.trigger("elCreated",this._model,this._el)},removeEl:function(){this._modelBinder!==undefined&&this._modelBinder.unbind(),this._el.remove(),this.trigger("elRemoved",this._model,this._el)},isElContained:function(e){return this._el===e||$(this._el).has(e).length>0},getModel:function(){return this._model},getEl:function(){return this._el}};return _.extend(t,this),t}}),Backbone.CollectionBinder.ViewManagerFactory=function(e){_.bindAll(this),this._viewCreator=e;if(!_.isFunction(this._viewCreator))throw"viewCreator must be a valid function that accepts a model and returns a backbone view"},_.extend(Backbone.CollectionBinder.ViewManagerFactory.prototype,{setParentEl:function(e){this._parentEl=e},getParentEl:function(){return this._parentEl},makeElManager:function(e){var t={_model:e,createEl:function(){this._view=this._viewCreator(e),$(this._parentEl).append(this._view.render(this._model).el),this.trigger("elCreated",this._model,this._view)},removeEl:function(){this._view.close!==undefined?this._view.close():this._view.$el.remove(),this.trigger("elRemoved",this._model,this._view)},isElContained:function(e){return this._view.el===e||this._view.$el.has(e).length>0},getModel:function(){return this._model},getView:function(){return this._view},getEl:function(){return this._view.$el}};return _.extend(t,this),t}})})();